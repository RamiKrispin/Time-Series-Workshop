---
title: "Bay Area useR Group - Time Series Workshop"
subtitle: ""
author: "Rami Krispin (@Rami_Krispin), Danton Noriega (@dantonnoriega)"
date: "`r format(as.Date('2019-10-05'), '%b %d, %Y')`"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
---

<style type="text/css">

body{ /* Normal  */
      font-size: 20px;
  }
td {  /* Table  */
  font-size: 8px;
}
h1.title {
  font-size: 38px;
  color: Black;
}
h1 { /* Header 1 */
  font-size: 28px;
  color: Blue;
}
h2 { /* Header 2 */
    font-size: 30px;
  color: Blue;
}
h3 { /* Header 3 */
  font-size: 25px;
  font-family: "Times New Roman", Times, serif;
  color: DarkBlue;
}
code.r{ /* Code block */
    font-size: 12px;
}
pre { /* Code block - determines code spacing between lines */
    font-size: 14px;
}
</style>



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.width=9, fig.height=5, warning=FALSE, message=FALSE)
```

## Agenda

* Introduction to time series analysis and forecasting
* Time series objects - introduction to the time series classes and their attributes
* Descriptive analysis of time series
* Linear regression-based forecasting models
* The ARIMA family of models

We will mainly focus today on methods for analyzing and forecasting regular time-series data with seasonality patterns

### Assumptions

* Some background in R
* Basic knowledge in probability
* Familiar with linear regression 

### Why R?

* Statistical programming language 
* A vast amount of [packages](https://cran.r-project.org/web/views/TimeSeries.html) for time series analysis
* The [forecast](http://pkg.robjhyndman.com/forecast/) package (and soon the [fable](https://fable.tidyverts.org/) package)

### Goals
By the end of this workshop, you probably won't become an expert in time series analysis and forecasting, but you will be able to:

* Explore time series data with some basic tools
* Use discriptive statistics for identifying seasonal and correlation patterns 
* Build basic forecasting model

### Admin

#### Workshop material

All today's slides, code, and rmarkdown files are available on [GitHub](https://github.com/RamiKrispin/Time-Series-Workshop)

Downloading the workshop material from the terminal:

```{bash, eval=FALSE}
git clone https://github.com/RamiKrispin/Time-Series-Workshop.git
```


Or lunch it from a docker container:

```{bash, eval=FALSE}

```


## Introduction to time series analysis

Time series analysis is commonly used in many fields of science, such as economics, finance, physics, engineering, and astronomy.  The usage of time series analysis to understand past events and to predict future ones did not start with the introduction of the stochastic process during the past century. Ancient civilizations such as the Greeks, Romans, or Mayans, researched and learned how to utilize cycled events such as weather and astronomy to predict future events. 


**Time series analysis** - is the art of extracting meaningful insights from time-series data to learn about past events and to predict future events. 

This process includes the following steps:

* **Data collection** - pulling the raw data from a database, API, flat files etc.
* **Data prep** - cleaning, reformating (dates, classes, etc.), aggregating
* **Descriptive analysis** - using statistical methods and data visualization tools to extract insights and learn about the series components and patterns
* **Predictive analysis** - leveraging the insights learned in the descriptive process and apply some predictive model 


Generally, in R this process will look like this:

```{r echo=FALSE, out.width="850px"}
knitr::include_graphics("images/Time Series Analysis Workflow.png")
```

Of course, there are more great packages that could be part of this process such as `zoo`, `xts`, `bsts`, `forecastHybird`, `TSstudio`, etc.


### Time series data

**Time series data** - is a sequence of values, each associate to a unique point in time that can divide to the following two groups:

* **Regular time series** - is a sequence of observations which were captured at equally spaced time intervals (e.g., every month, week, day, hour, etc.)
* **Irregular time series** - or unevenly spaced time series, is a sequence of observations which were not captured on equally spaced time intervals (for example rainy days, earthquakes, clinical trials, etc.)



**Note:** typically, the term time series data referred to regular time-series data. Therefore, if not stated otherwise, throughout the workshop the term time series (or series) refer to regular time-series data

### Examples of time series data

```{r echo = TRUE, echo=FALSE, warning=FALSE, message=FALSE}
library(UKgrid)

data(UKgrid)
UKgrid <- extract_grid(type = "data.frame", start = as.Date("2018-01-01"), end = as.Date("2018-01-31"))
TSstudio::ts_plot(UKgrid, title = "The Demand for Electricity in the UK (Half-Hourly Intervals)", Ytitle = "MW", Xtitle = "Date")

library(TSstudio)


TSstudio::ts_plot(USgas, title = "US Monthly Natural Gas Consumption", Ytitle = "Billion Cubic Feet", Xtitle = "Date")
TSstudio::ts_plot(USVSales, title = "US Monthly Total Vehicle Sales", Ytitle = "Thousands of Units", Xtitle = "Date")



```


### Applications

With time series analysis, you can answer questions such as:

* How many vehicles, **approximately**, going to be sold in the US in the next 12 months?
* What will be the **estimated** demand for natural gas in the US in the next five years?
* **Generally**, what will be the demand for electricity in the UK during the next 24 hours?


## Time series objects

There are multiple classes in R for time-series data, the most common types are:

* The `ts` class for regular time-series data, and `mts` class for multiple time seires objects , the most common class for time series data
* The `xts` and `zoo` classes for both regular and irregular time series data, mainly popular in the financial field
* The `tsibble` class, a tidy format for time series data, support both regular and irregular time-series data

### The attribute of time series object

A typical time series object should have the following attributes:

* A vector or matrix objects with sequential observations
* Index or timestamp
* Frequency units
* Cycle units

Where the frequency of the series represents the units of the cycle. For example, for monthly series, the frequency units are the month of the year, and the cycle units are the years. Similarly, for daily series, the frequency units could be the day of the year, and the cycle units are also the years. 

The **stats** package provides a set of functions for handling and extracting information from a `ts` object. The `frequency` and `cycle` functions, as their names implay return the frequency and the cycle, respectivly, of the object. Let's load the `USgas` series from the `TSstudio` package  and apply those functions:

```{r}
library(TSstudio)
data(USgas)

class(USgas)
is.ts(USgas)
frequency(USgas)
cycle(USgas)
```

The `time` function returns the series index or timestamp:

```{r}
head(time(USgas))
```

The `deltat` function returns the length of series' time interval (which is equivalent to 1/frequency):

```{r}
deltat(USgas)
```

Similarly, the `start` and `end` functions return the starting and ending time of the series, respectively:

```{r}
start(USgas)
end(USgas)
```

Where the left number represents the cycle units, and the right side represents the frequency units of the series. The `tsp` function returns both the start and end of the series and its frequency:

```{r}
tsp(USgas)
```

Last but not least, the `ts_info` function from the **TSstudio** package returns a concise summary of the series:

```{r}
ts_info(USgas)
```




### Creating a ts object

The `ts` function allows to create a `ts` object from a single vector and a `mts` object from a multiple vectors (or matrix). By defining the start (or end) and frequency of the series, the function generate the object index. In the following example we will load the `US_indicators` dataset from the TSstudio package and convert it to a ts object. The `US_indicators` is a `data.frame` with the monthly vehicle sales and unemployment rate in the US since 1976:


```{r}
data(US_indicators)

head(US_indicators)
```


```{r}
mts_obj <- ts(data = US_indicators[, c("Vehicle Sales", "Unemployment Rate")], 
              start = c(1976, 1),
              frequency = 12)

ts_info(mts_obj)
```

### How to define the start and frequency arguments?

Series Type | Cycle Units | Frequency Units| Frequency
------------|-------------|----------------|-----------
Quarterly | Years | Quarter of the year | 4
Monthly | Years | Month of the year | 12
Weekly | Years | Week of the year | 52
Daily | Years | Day of the year | 365


What if you have more granular time series data such as half-hour, 15 or five minutes intervals?

Below me when needed to work with daily time series using `ts` object:

```{r echo=FALSE, out.width="650px"}
knitr::include_graphics("http://giphygifs.s3.amazonaws.com/media/eIPM3j6YXHKXC/giphy.gif")
```

### The disadvantages of the ts object
 
The ts object was designed for work with monthly, quarterly, or yearly series that have only two-time components (e.g., year and month). Yet, more granular series (high frequency) may have more than two-time components. A common example is a daily series that has the following time attributes:

* Year
* Month
* Day of the year
* Day of the week

When going to the hourly or minute levels, this is even adding more components such as the hour, minute, etc.

The `zoo`, `xts` classes and now the `tsibble` class provide solution for this issue.  


### The tsibble class

"The **tsibble** package provides a data infrastructure for tidy temporal data with wrangling tools..." 

In other words, the `tsibble` object allows you to work with a data frame alike (i.e., `tbl` object) with a time awareness attribute. The key characteristics of this class:

* It has a date/time object as an index
* Using key to store multiple time series objects
* A `tbl` object - can apply any of the normal tools to reformat, clean or modify `tbl` object such as `dplyr` functions

The reaction of me and my colegues when the tsibble **package** was released:

```{r echo=FALSE, out.width="650px"}
knitr::include_graphics("https://media.giphy.com/media/Yb3d5B1zwuhCo/giphy.gif")
```


### Creating a tsibble object

```{r}
library(UKgrid)

data(UKgrid)

class(UKgrid)

head(UKgrid)
```
```{r}
library(dplyr)

uk_grid <- UKgrid %>% 
  dplyr::select(time = TIMESTAMP, 
                net_demand = ND, 
                wind_gen = EMBEDDED_WIND_GENERATION, 
                solar_gen = EMBEDDED_SOLAR_GENERATION)
```



## Descriptive analysis of time series

Like most common fields of statistics and machine learning, the goal of the descriptive analysis is to reveal meaningful insights about the series and the key components of its structure.

### The time series components



* Trend
* Cycle
* Seasonal
* Irregular

```{r}
ts_decompose(USgas)
```


